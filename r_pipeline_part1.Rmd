---
title: "R pipeline part 1"
author: "Katie Wang"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(coXpress)

library(WGCNA)          ###used for topological overlap calculation and clustering steps
library(RColorBrewer)   ###used to create nicer colour palettes
library(preprocessCore) ###used by the quantile normalization function
library(flashClust)
```


Input: very lightly pre-processed data files exported by Go. Two .csvs of expression data, split by condition. If the data is the rat data, the .csvs are for Eker mutant and wild type. If the data is the Golub data, the .csvs are for ALL and AML.  

What's done in this file: the two input data files are put into the exact format required by coXpress and by DiffCoEx. Then the analyses are run, and output data is generated.  

Output: two files, one per algorithm. Each contains the list of gene modules generated by an algorithm. This will be pipelined back to Go for additional steps (in particular, significance testing). Part 2 of the R section of the pipeline will be for data visualization.  

# Processing inputs
Once the pipeline is set up and we know the directory name, use this chunk to set the directory for reading files in.
```{r}
# TODO: set filepath

# Also TODO: when the pipeline is set up, make it so the exported files are named generically 
# (e.g. "c1_samples.csv" and "c2_samples.csv") so that we can just run this .Rmd regardless of what intput data was
# c1_filename <- "c1_samples.csv"
# c2_filename <- "c2_samples.csv"

c1_filename <- "all_samples.csv" # comment out once the pipeline is running
c2_filename <- "aml_samples.csv" # comment out once the pipeline is running
```

## coXpress
For the most part, we can use the pre-processed data as-is after reading it in.
```{r}
c1 <- read.table(c1_filename, sep=",", header=FALSE, row.names=1)
c2 <- read.table(c2_filename, sep=",", header=FALSE, row.names=1)
```

If using the coXpress() function, we'll need to join the two conditions into a single dataset. However, I don't think we'll need to do that, since the modules are generated using cluster.gene() and cutree().


## DiffCoEx
This requires that the two dataframes are transposed.
```{r}
c1_t <- t(c1)
c2_t <- t(c2)
```

# Running the analyses
## coXpress
Generate hc.gene.
```{r}
# Cluster on condition 1
hc.gene  <- cluster.gene(c1,s="pearson",m="average")
```

Cut the tree (hc.gene) at a height of 0.4 (equates to pearson correlation of 0.6). This choice of cut off is user defined and should be in the range 0 < h < 2.  A low value will produce many modules (groups) with few genes in each module; a large value will produce few modules with many genes.
```{r}
module <- cutree(hc.gene, h=0.4)

# make the formatting a bit nicer
coX_modules_df <- data.frame(module) |>
  rownames_to_column("gene") # these are the gene markers
  
coX_modules_df <- coX_modules_df[order(coX_modules_df$module), ] # sorting by module number for easy viewing
head(coX_modules_df)

coX_modules_df |>
  group_by(module) |>
  summarize(num_genes=n())
```
As seen above, there are currently 1039 "modules". We'll filter out modules of size 1, as these genes aren't really coexpressed.
```{r}
coX_modules_df <- coX_modules_df |>
  group_by(module) |>
  filter(n() > 1) |>
  ungroup()

coX_modules_df |>
  group_by(module) |>
  summarize(num_genes=n())
```
This leaves us with 617 modules, each of which has at least one gene in it.

## DiffCoEx
TODO
Set up a df in the same format as coX_modules_df: one column for gene identifiers, another column for 

# Exporting files for the next step of the Go pipeline
At this point, we should have two lists of modules. We'll export these so that significance testing can be done in Go.

## coXpress
```{r}
filepath1 <- "coX_modules.csv" # TODO: after the pipeline is set up, change the filepath as needed
write.csv(coX_modules_df, filepath1, row.names=FALSE)
```

## DiffCoEx
```{r}
filepath2 <- "DCE_modules.csv" # TODO: after the pipeline is set up, change the filepath as needed
# TODO: insert the name of the DCE modules df below
# write.csv(TODO, filepath2, row.names=FALSE)
```

